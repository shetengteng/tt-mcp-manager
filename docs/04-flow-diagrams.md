# 流程图文档

## 🔄 用户操作流程

### 1. 从模板创建服务器流程

```
开始
  │
  ▼
打开 MCP Manager
  │
  ▼
点击"从模板创建"
  │
  ▼
┌─────────────────┐
│ 选择模板        │
│ - 文件系统      │
│ - Git 操作      │
│ - 网络搜索      │
│ - 数据库        │
│ - HTTP 请求     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 填写配置信息    │
│ - 服务器名称    │
│ - 必填参数      │
│ - 高级选项      │
└────────┬────────┘
         │
         ▼
  验证配置是否正确?
         │
    ┌────┴────┐
    │         │
   否         是
    │         │
    │         ▼
    │  创建服务器配置
    │         │
    │         ▼
    │  是否自动启动?
    │         │
    │    ┌────┴────┐
    │    │         │
    │   否         是
    │    │         │
    │    │         ▼
    │    │  检查并安装依赖
    │    │         │
    │    │         ▼
    │    │   依赖已安装?
    │    │         │
    │    │    ┌────┴────┐
    │    │    │         │
    │    │   否         是
    │    │    │         │
    │    │    ▼         │
    │    │  安装依赖     │
    │    │  (npm/pip)   │
    │    │    │         │
    │    │    └────┬────┘
    │    │         │
    │    │         ▼
    │    │   启动 MCP Server
    │    │         │
    │    │         ▼
    │    │   启动成功?
    │    │         │
    │    │    ┌────┴────┐
    │    │    │         │
    │    │   否         是
    │    │    │         │
    │    │    ▼         ▼
    └────┼───> 显示错误  显示成功
         │      │         │
         └──────┴─────────┘
                 │
                 ▼
              完成
```

### 2. 从市场安装服务器流程

```
开始
  │
  ▼
进入市场页面
  │
  ▼
┌─────────────────┐
│ 搜索/筛选       │
│ - 输入关键词    │
│ - 选择分类      │
│ - 选择语言      │
│ - 排序方式      │
└────────┬────────┘
         │
         ▼
显示搜索结果列表
  │
  ▼
浏览服务器卡片
  │
  ▼
点击"详情"查看
  │
  ▼
┌─────────────────┐
│ 查看详细信息    │
│ - README        │
│ - Star 数       │
│ - 下载量        │
│ - 使用示例      │
└────────┬────────┘
         │
         ▼
  决定是否安装?
         │
    ┌────┴────┐
    │         │
   否         是
    │         │
    │         ▼
    │  点击"安装"
    │         │
    │         ▼
    │  检测安装类型
    │         │
    │    ┌────┴────┬─────────┐
    │    │         │         │
    │   NPM      Python     Git
    │    │         │         │
    │    ▼         ▼         ▼
    │  执行       执行      Clone
    │  npm       pip       仓库
    │  install   install    │
    │    │         │         │
    │    └────┬────┴─────────┘
    │         │
    │         ▼
    │   安装成功?
    │         │
    │    ┌────┴────┐
    │    │         │
    │   否         是
    │    │         │
    │    ▼         ▼
    │  显示错误  解析配置
    │    │         │
    │    │         ▼
    │    │  自动生成服务器配置
    │    │         │
    │    │         ▼
    │    │  添加到服务器列表
    │    │         │
    │    │         ▼
    │    │  提示配置参数
    │    │         │
    └────┼─────────┘
         │
         ▼
      完成
```

### 3. 启动/停止服务器流程

```
启动服务器
  │
  ▼
获取服务器配置
  │
  ▼
检查依赖是否已安装
  │
  ▼
依赖已安装?
  │
  ┌─┴─┐
  否  是
  │   │
  │   ▼
  │ spawn() 启动进程
  │   │
  │   ▼
  │ 监听进程事件
  │   ├─ stdout (标准输出)
  │   ├─ stderr (错误输出)
  │   └─ exit (进程退出)
  │   │
  │   ▼
  │ 更新服务器状态为"运行中"
  │   │
  │   ▼
  │ 开始收集日志
  │   │
  ▼   ▼
显示错误/成功

──────────────────────────────

停止服务器
  │
  ▼
获取进程 PID
  │
  ▼
发送 SIGTERM 信号
  │
  ▼
等待 5 秒
  │
  ▼
进程是否已退出?
  │
  ┌─┴─┐
  否  是
  │   │
  │   ▼
  │ 更新状态为"已停止"
  │   │
  ▼   ▼
发送 SIGKILL 完成
强制终止
  │
  ▼
更新状态为"已停止"
  │
  ▼
完成
```

### 4. 导出配置到 Cursor 流程

```
开始
  │
  ▼
点击"导出配置"
  │
  ▼
读取所有服务器配置
  │
  ▼
转换为 Cursor 格式
  │
  ▼
┌─────────────────────────┐
│ 生成配置文件            │
│ {                       │
│   "mcpServers": {       │
│     "server1": {...},   │
│     "server2": {...}    │
│   }                     │
│ }                       │
└────────┬────────────────┘
         │
         ▼
  选择导出方式
         │
    ┌────┴────┬─────────┐
    │         │         │
 复制到     保存到    直接写入
 剪贴板     文件     Cursor配置
    │         │         │
    │         ▼         ▼
    │    选择保存   检查Cursor
    │    位置       配置路径
    │         │         │
    │         ▼         ▼
    │    保存文件   写入文件
    │         │         │
    └────┬────┴─────────┘
         │
         ▼
   显示成功提示
         │
         ▼
      完成
```

## 🏗️ 系统内部流程

### 5. 进程管理流程

```
┌──────────────────────────────────────────────┐
│         ProcessManager 进程生命周期          │
└──────────────────────────────────────────────┘

创建进程
  │
  ▼
┌──────────────┐
│ 准备阶段     │
│ - 验证配置   │
│ - 设置环境变量│
│ - 确定工作目录│
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 启动阶段     │
│ - spawn()    │
│ - 设置 stdio │
│ - 添加到进程表│
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 运行阶段     │
│ - 监听输出   │
│ - 收集日志   │
│ - 心跳检测   │
└──────┬───────┘
       │
       ├───────────────┐
       │               │
   进程正常运行    进程异常退出
       │               │
       │               ▼
       │         是否启用自动重启?
       │               │
       │          ┌────┴────┐
       │          │         │
       │         是         否
       │          │         │
       │          ▼         ▼
       │    检查重启次数  标记为错误
       │          │         │
       │          ▼         │
       │    超过限制?       │
       │          │         │
       │     ┌────┴────┐    │
       │     │         │    │
       │    是         否   │
       │     │         │    │
       │     ▼         ▼    │
       │  标记为错误  重启进程
       │     │         │    │
       │     └────┬────┘    │
       │          │         │
       ▼          ▼         ▼
   用户停止  自动清理  显示错误
       │          │         │
       └──────────┴─────────┘
                  │
                  ▼
            清理资源
                  │
                  ▼
          从进程表移除
                  │
                  ▼
               完成
```

### 6. 日志管理流程

```
┌──────────────────────────────────────────────┐
│           LogManager 日志处理流程             │
└──────────────────────────────────────────────┘

MCP Server 输出日志
  │
  ▼
ProcessManager 捕获
  │
  ├─ stdout (标准输出)
  │   │
  │   ▼
  │ 解析日志级别
  │   │
  │   ▼
  │ 添加时间戳
  │   │
  │   └─┐
  │     │
  └─ stderr (错误输出)
      │
      ▼
    标记为 ERROR
      │
      └─┐
        │
        ▼
  LogManager.addLog()
        │
        ▼
  ┌─────────────┐
  │ 日志预处理  │
  │ - 格式化    │
  │ - 添加元数据│
  │ - 着色      │
  └─────┬───────┘
        │
        ▼
  ┌─────────────┐
  │ 存储日志    │
  │ - 内存缓存  │
  │ - 文件写入  │
  └─────┬───────┘
        │
        ▼
  检查日志数量
        │
        ▼
  超过限制?
        │
   ┌────┴────┐
   │         │
  是         否
   │         │
   ▼         │
清除最旧的   │
日志         │
   │         │
   └────┬────┘
        │
        ▼
  ┌─────────────┐
  │ 实时推送    │
  │ - IPC 事件  │
  │ - WebSocket │
  └─────┬───────┘
        │
        ▼
  渲染进程接收
        │
        ▼
  UI 更新显示
        │
        ▼
     完成
```

### 7. 市场数据获取流程

```
┌──────────────────────────────────────────────┐
│      MarketplaceService 数据获取流程          │
└──────────────────────────────────────────────┘

用户搜索 MCP Server
  │
  ▼
构建搜索查询
  │
  ├─ 关键词
  ├─ 分类
  ├─ 语言
  └─ 排序方式
  │
  ▼
检查本地缓存
  │
  ▼
缓存有效?
  │
  ┌─┴─┐
  是  否
  │   │
  │   ▼
  │ 调用 GitHub API
  │   │
  │   ▼
  │ 搜索仓库
  │   │
  │   ▼
  │ 获取基本信息
  │   │
  │   ├─ 名称、描述
  │   ├─ Star 数
  │   ├─ 创建/更新时间
  │   ├─ 语言
  │   └─ Topics
  │   │
  │   ▼
  │ 并行请求额外信息
  │   │
  │   ├───────┬───────┬───────┐
  │   │       │       │       │
  │  README  package npm下载量 分类
  │   │     .json     │      检测
  │   │       │       │       │
  │   └───────┴───────┴───────┘
  │           │
  │           ▼
  │     合并数据
  │           │
  │           ▼
  │    存入缓存
  │           │
  ▼           ▼
返回缓存  返回结果
  │           │
  └─────┬─────┘
        │
        ▼
  渲染到UI
        │
        ▼
     完成
```

### 8. IPC 通信流程

```
┌──────────────────────────────────────────────┐
│              IPC 通信流程                     │
└──────────────────────────────────────────────┘

渲染进程 (Vue 组件)
  │
  ▼
调用 window.electronAPI
  │
  ▼
例: window.electronAPI.server.start(id)
  │
  ▼
Preload 脚本转发
  │
  ▼
ipcRenderer.invoke('server:start', id)
  │
  ═══════════════════════════════════
  │      IPC Channel (安全边界)
  ═══════════════════════════════════
  │
  ▼
主进程接收
  │
  ▼
ipcMain.handle('server:start', ...)
  │
  ▼
调用对应的服务
  │
  ▼
ProcessManager.startServer(id)
  │
  ▼
执行业务逻辑
  │
  ├─ 成功
  │   │
  │   ▼
  │ 返回结果
  │   │
  │   └─┐
  │     │
  └─ 失败
      │
      ▼
    抛出错误
      │
      └─┐
        │
  ═══════════════════════════════════
  │      返回结果
  ═══════════════════════════════════
        │
        ▼
  Preload 脚本接收
        │
        ▼
  返回给渲染进程
        │
        ▼
  Vue 组件处理结果
        │
    ┌───┴───┐
    │       │
  成功     失败
    │       │
    ▼       ▼
  更新UI  显示错误
    │       │
    └───┬───┘
        │
        ▼
     完成
```

## 📡 事件流程

### 9. 实时日志推送流程

```
MCP Server 输出
  │
  ▼
ProcessManager 捕获
  │
  ▼
LogManager.addLog()
  │
  ▼
触发事件
  │
  ├───────────────┬───────────────┐
  │               │               │
IPC 推送      WebSocket 推送  文件写入
  │               │               │
  ▼               ▼               ▼
渲染进程监听    浏览器/外部    日志文件
  │             应用监听          │
  ▼               │               │
Store 更新        │               │
  │               │               │
  ▼               ▼               ▼
LogViewer    外部显示      持久化存储
组件更新
```

### 10. 服务器状态变化流程

```
服务器状态改变
  │
  ├─ 启动成功
  ├─ 停止
  ├─ 错误
  └─ 重启
  │
  ▼
ProcessManager 更新状态
  │
  ▼
触发状态变化事件
  │
  ├───────────────┬───────────────┐
  │               │               │
通知渲染进程    通过 API     保存到配置
  │             通知外部          │
  ▼               │               │
UI 更新状态     │               │
指示器          │               │
  │             │               │
  └─────────────┴───────────────┘
                │
                ▼
          记录到日志
```

